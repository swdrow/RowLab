---
phase: 30-erg-data-migration
plan: 03
type: execute
wave: 2
depends_on: ["30-01", "30-02"]
files_modified:
  - src/v2/pages/ErgTestsPage.tsx
  - src/v2/components/erg/ErgLeaderboard.tsx
  - src/v2/components/erg/ErgTestsTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can see improved erg leaderboard with better UX on the erg page"
    - "User sees PR celebration inline when a personal record is set after creating a test"
    - "User can see gamification badges (PR indicators) in the erg test table"
    - "Leaderboard shows athlete rankings with trend indicators and test type tabs"
  artifacts:
    - path: "src/v2/components/erg/ErgLeaderboard.tsx"
      provides: "Improved leaderboard component with tabs and trend indicators"
      contains: "useErgLeaderboard|TestType"
    - path: "src/v2/pages/ErgTestsPage.tsx"
      provides: "Erg page with leaderboard tab and PR celebration integration"
      contains: "ErgLeaderboard|PRCelebration|usePRCelebration"
  key_links:
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/components/erg/ErgLeaderboard.tsx"
      via: "component import"
      pattern: "ErgLeaderboard"
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/features/gamification/components/PRCelebration.tsx"
      via: "component import"
      pattern: "PRCelebration"
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/hooks/usePersonalRecords.ts"
      via: "hook import"
      pattern: "usePRCelebration"
---

<objective>
Add improved leaderboard UX to the erg page and integrate PR celebration animations with gamification badges.

Purpose: ERG-01 (improved leaderboard UX), ERG-02 (PR celebrations), and ERG-03 (gamification integration) are the core feature requirements for this phase. The existing leaderboard is hook-only (useErgLeaderboard) with a minimal dashboard widget. This plan creates a proper leaderboard component and wires PR celebrations into the erg test creation flow.

Output: ErgTestsPage has a Leaderboard tab with improved UX, PR celebrations appear inline when records are set, and test table rows show PR indicators.
</objective>

<execution_context>
@/home/swd/.claude/get-shit-done/workflows/execute-plan.md
@/home/swd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/v2/pages/ErgTestsPage.tsx
@src/v2/hooks/useErgTests.ts
@src/v2/hooks/usePersonalRecords.ts
@src/v2/features/gamification/components/PRCelebration.tsx
@src/v2/features/dashboard/components/widgets/ErgLeaderboardWidget.tsx
@src/v2/components/erg/ErgTestsTable.tsx
@.planning/phases/30-erg-data-migration/30-01-SUMMARY.md
@.planning/phases/30-erg-data-migration/30-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create improved ErgLeaderboard component with tabs and trend indicators</name>
  <files>
    src/v2/components/erg/ErgLeaderboard.tsx
    src/v2/components/erg/index.ts
  </files>
  <action>
    Create `src/v2/components/erg/ErgLeaderboard.tsx`:

    **Structure:**
    1. Test type tab bar (2K, 6K, 30min, 500m) — button group styled with design tokens, active tab uses `bg-interactive-primary text-white`, inactive uses `bg-bg-surface text-txt-secondary hover:bg-bg-active`
    2. Leaderboard list showing top athletes for selected test type
    3. Each leaderboard row displays:
       - Rank number (1-3 get gold/silver/bronze accent — use `text-accent-gold`, `text-txt-secondary`, `text-accent-copper`)
       - Athlete name + avatar initial circle
       - Best time in monospace (`font-mono tabular-nums text-txt-primary`)
       - Split/500m pace in smaller text
       - Watts if available
       - Trend indicator: up arrow (improved), down arrow (declined), dash (no change) relative to previous test — use `text-data-excellent` for improvement, `text-data-poor` for decline
    4. Loading state: Use a leaderboard-specific skeleton (inline, 8 rows of skeleton blocks)
    5. Empty state: "No tests recorded for {testType}" with subtle empty state styling

    **Data:**
    - Use `useErgLeaderboard(selectedTestType, 20)` hook for data
    - Track selected test type in local state, default to '2k'

    **Styling:**
    - Glass card container (`bg-bg-surface border border-bdr-default rounded-2xl`)
    - Header with "Leaderboard" title and test type tabs
    - Rows with hover state (`hover:bg-bg-active`)
    - Top 3 have subtle gold/silver/bronze left border accents
    - Use Framer Motion `AnimatePresence` + `motion.div` with `FADE_IN_VARIANTS` for row animations when switching test types

    **Export:**
    - Add `ErgLeaderboard` export to `src/v2/components/erg/index.ts`
  </action>
  <verify>
    Run: `npm run build` — should succeed.
    Run: `grep "ErgLeaderboard" src/v2/components/erg/index.ts` — should find export.
  </verify>
  <done>
    ErgLeaderboard component renders with test type tabs, ranked athlete list with trend indicators, glass card styling, skeleton loading state, and empty state. Exported from barrel file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate leaderboard, PR celebrations, and gamification into ErgTestsPage</name>
  <files>
    src/v2/pages/ErgTestsPage.tsx
    src/v2/components/erg/ErgTestsTable.tsx
  </files>
  <action>
    **ErgTestsPage.tsx — Add view tabs (Tests / Leaderboard):**
    1. Add a view toggle at the top of the content area: "Tests" | "Leaderboard" tabs
    2. "Tests" view shows the existing table (default)
    3. "Leaderboard" view shows the new `ErgLeaderboard` component
    4. Use button group styling consistent with test type filters

    **ErgTestsPage.tsx — PR celebration integration:**
    5. After successful test creation (in `handleSubmit` onSuccess), track the created test ID in state: `const [lastCreatedTestId, setLastCreatedTestId] = useState<string | null>(null)`
    6. Use `usePRCelebration(lastCreatedTestId || '')` to check if the newly created test is a PR
    7. When PR data returns with `isPR: true`, render `<PRCelebration data={prData} />` in a dismissible banner at the top of the content area
    8. Auto-dismiss after 10 seconds or on user click
    9. Use `AnimatePresence` for smooth enter/exit of the PR celebration banner

    **ErgTestsTable.tsx — PR indicator badges:**
    10. Accept optional `prTestIds?: Set<string>` prop
    11. In the athlete column cell, if `prTestIds?.has(row.original.id)`, render a small gold trophy icon (`Trophy` from lucide-react, size 14, `text-accent-gold`) next to the athlete name
    12. Tooltip on hover: "Personal Record"

    **Note:** The `prTestIds` set would be populated by the parent page. For now, after creating a test that's detected as a PR, add its ID to a local Set. Full PR detection for all visible tests is a future enhancement (would require querying each test).
  </action>
  <verify>
    Run: `npm run build` — should succeed.
    Verify ErgTestsPage imports ErgLeaderboard and PRCelebration correctly.
  </verify>
  <done>
    ErgTestsPage has Tests/Leaderboard view toggle. Leaderboard shows ranked athletes with trend indicators per test type. PR celebration banner appears after creating a personal record test. Table rows show gold trophy icon for PR tests. All animations use SPRING_CONFIG/FADE_IN_VARIANTS.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. ErgTestsPage renders both Tests and Leaderboard views
3. Leaderboard shows proper rankings with trend indicators
4. PR celebration appears after creating a test that beats personal best
5. Trophy icon appears next to athlete name for PR tests
</verification>

<success_criteria>
- Leaderboard has improved UX with tabs, trend indicators, and glass card styling (ERG-01)
- PR celebration animations appear inline when records are set (ERG-02)
- Gamification indicators (trophy icons) visible in test table (ERG-03)
- All new components use V3 design tokens
</success_criteria>

<output>
After completion, create `.planning/phases/30-erg-data-migration/30-03-SUMMARY.md`
</output>
