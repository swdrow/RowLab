---
phase: 30-erg-data-migration
plan: 04
type: execute
wave: 3
depends_on: ["30-03"]
files_modified:
  - src/store/ergDataStore.js
  - src/components/ErgData/AddErgTestModal.jsx
  - src/components/ErgData/ErgDataModal.jsx
  - src/components/PerformanceView/ErgDataTable.jsx
  - src/components/Charts/ErgTrendChart.jsx
  - src/pages/ErgDataPage.jsx
  - server/routes/ergData.js
autonomous: false

must_haves:
  truths:
    - "V1 erg data files are deprecated with clear @deprecated markers"
    - "No V2/V3 code imports from V1 erg files"
    - "V1 legacy route /api/v1/erg-data is documented for removal"
    - "All erg features work correctly with V3 design tokens, skeletons, and keyboard shortcuts"
  artifacts:
    - path: "src/store/ergDataStore.js"
      provides: "Deprecated V1 store with warning"
      contains: "@deprecated"
    - path: "src/components/ErgData/AddErgTestModal.jsx"
      provides: "Deprecated V1 modal"
      contains: "@deprecated"
  key_links:
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/hooks/useErgTests.ts"
      via: "TanStack Query hook (not V1 store)"
      pattern: "useErgTests"
---

<objective>
Deprecate V1 legacy erg files and perform human verification of the complete erg data migration.

Purpose: Clean up V1 legacy code that has been superseded by V2/V3 implementations, and verify all Phase 30 changes work correctly together.

Output: V1 erg files marked as deprecated. Human verification confirms all erg features work with V3 design system.
</objective>

<execution_context>
@/home/swd/.claude/get-shit-done/workflows/execute-plan.md
@/home/swd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/30-erg-data-migration/30-01-SUMMARY.md
@.planning/phases/30-erg-data-migration/30-02-SUMMARY.md
@.planning/phases/30-erg-data-migration/30-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deprecate V1 legacy erg files</name>
  <files>
    src/store/ergDataStore.js
    src/components/ErgData/AddErgTestModal.jsx
    src/components/ErgData/ErgDataModal.jsx
    src/components/PerformanceView/ErgDataTable.jsx
    src/components/Charts/ErgTrendChart.jsx
    src/pages/ErgDataPage.jsx
  </files>
  <action>
    1. Verify no V2/V3 code imports from these V1 files:
       - Run: `grep -rn "ergDataStore\|ErgDataModal\|AddErgTestModal\|ErgDataTable\|ErgTrendChart\|ErgDataPage" src/v2/ --include="*.tsx" --include="*.ts"`
       - If any V2 imports found, they need to be replaced with V2 equivalents before deprecation.

    2. Add `@deprecated` JSDoc comment to the top of each V1 file:
       ```
       /**
        * @deprecated V1 Legacy — replaced by V2/V3 erg data components.
        * See: src/v2/pages/ErgTestsPage.tsx, src/v2/components/erg/
        * Removal planned: Phase 36 (V1/V2 Cleanup)
        */
       ```

    3. Check if `server/routes/ergData.js` is still mounted. If so, add a deprecation comment:
       ```
       /**
        * @deprecated V1 Legacy erg data routes — replaced by /api/v1/erg-tests
        * Removal planned: Phase 36 (V1/V2 Cleanup)
        */
       ```

    4. Verify V1 ErgDataPage.jsx is NOT in the active route tree:
       - Check `src/App.jsx` or router config for references to `ErgDataPage`
       - If still routed, it should redirect to `/app/erg-tests` (V2 route)

    5. Check `src/components/Charts/index.js` — if ErgTrendChart is exported, add deprecation notice but keep export for backward compatibility.
  </action>
  <verify>
    Run: `grep -rn "ergDataStore\|ErgDataModal\|AddErgTestModal" src/v2/ --include="*.tsx" --include="*.ts"` — zero matches (no V2 code depends on V1)
    Run: `grep -l "@deprecated" src/store/ergDataStore.js src/components/ErgData/AddErgTestModal.jsx src/components/ErgData/ErgDataModal.jsx src/components/PerformanceView/ErgDataTable.jsx src/components/Charts/ErgTrendChart.jsx` — all files contain @deprecated
    Run: `npm run build` — should succeed
  </verify>
  <done>
    All V1 erg files marked with @deprecated. No V2/V3 code imports from V1 erg files. Legacy API route documented for Phase 36 removal. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Phase 30 Erg Data Migration — complete V3 migration including:
    1. All 14 erg components migrated to V3 design tokens (no hardcoded colors)
    2. PRCelebration migrated to design tokens and SPRING_CONFIG
    3. All loading spinners replaced with skeleton loaders
    4. Keyboard shortcuts (J/K navigate, E edit, Del delete, / filter, ? help)
    5. Improved leaderboard with test type tabs and trend indicators
    6. PR celebration inline banner after creating personal records
    7. Gold trophy indicators for PR tests in table
    8. V1 legacy files deprecated
  </what-built>
  <how-to-verify>
    1. Navigate to http://100.86.4.57:3001/app/erg-tests
    2. Verify page loads with skeleton loaders (not spinners) during data fetch
    3. Verify test type badges show distinct colors (red for 2K, blue for 6K, green for 30min, amber for 500m) — all using design tokens
    4. Press ? to see keyboard shortcuts help overlay
    5. Press J/K to navigate between test rows — verify row highlight
    6. Press E on a highlighted row — verify edit modal opens
    7. Click "Leaderboard" tab — verify leaderboard renders with athlete rankings and trend indicators
    8. Switch between 2K/6K/30min/500m tabs in leaderboard — verify data updates
    9. Add a new erg test — if it's a PR, verify gold celebration banner appears
    10. Check that the Concept2 status panel still works (click C2 Status button)
    11. Verify CSV import wizard still functions (click Import CSV)
    12. Verify no visual regressions — colors should feel warm and consistent with V3 design
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. V1 erg files deprecated with clear markers
2. All Phase 30 requirements met:
   - ERG-01: Improved leaderboard with better UX (tabs, trends)
   - ERG-02: PR celebration animations on record-setting tests
   - ERG-03: Gamification integration (trophy indicators, PR detection)
   - CW-01: Optimistic UI (already existed, preserved)
   - CW-02: Keyboard shortcuts (J/K/E/Del///?)
   - CW-03: Skeleton loaders (all spinners replaced)
3. `npm run build` passes
4. Human verification approved
</verification>

<success_criteria>
- V1 legacy code deprecated (not deleted — Phase 36 handles removal)
- All 6 Phase 30 success criteria verified by human
- No visual regressions from design token migration
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-erg-data-migration/30-04-SUMMARY.md`
</output>
