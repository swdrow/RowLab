---
phase: 30-erg-data-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/v2/pages/ErgTestsPage.tsx
  - src/v2/features/erg/components/ErgSkeleton.tsx
  - src/v2/hooks/useErgKeyboard.ts
autonomous: true

must_haves:
  truths:
    - "User sees skeleton loaders (not spinners) when erg data loads"
    - "User can navigate erg test rows with J/K keyboard shortcuts"
    - "User can press E to edit selected row, Delete to delete"
    - "User can press / to focus search/filter, ? to show help"
    - "Keyboard shortcuts are disabled when modal/dialog is open"
  artifacts:
    - path: "src/v2/pages/ErgTestsPage.tsx"
      provides: "V3-compliant erg page with skeletons and keyboard"
      contains: "ErgTableSkeleton|useErgKeyboard"
    - path: "src/v2/hooks/useErgKeyboard.ts"
      provides: "Keyboard shortcut hook for erg page"
      contains: "handleKeyDown|shouldIgnoreEvent"
    - path: "src/v2/features/erg/components/ErgSkeleton.tsx"
      provides: "Updated skeleton loaders for V3 erg page"
  key_links:
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/hooks/useErgKeyboard.ts"
      via: "hook import"
      pattern: "useErgKeyboard"
    - from: "src/v2/pages/ErgTestsPage.tsx"
      to: "src/v2/features/erg/components/ErgSkeleton.tsx"
      via: "component import"
      pattern: "ErgTableSkeleton"
---

<objective>
Replace all loading spinners with skeleton loaders and add keyboard shortcuts to the erg tests page.

Purpose: CW-03 (skeleton loaders instead of spinners) and CW-02 (keyboard shortcuts) are cross-cutting V3 requirements. This plan addresses both for the erg data feature.

Output: ErgTestsPage uses skeleton loaders for all loading states and supports full keyboard navigation (J/K/E/Delete///?) matching the pattern established in Phase 28 athletes.
</objective>

<execution_context>
@/home/swd/.claude/get-shit-done/workflows/execute-plan.md
@/home/swd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/v2/pages/ErgTestsPage.tsx
@src/v2/features/erg/components/ErgSkeleton.tsx
@src/v2/hooks/useAthleteKeyboard.ts
@src/v2/components/erg/ErgTestsTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace spinners with skeleton loaders on ErgTestsPage</name>
  <files>
    src/v2/pages/ErgTestsPage.tsx
    src/v2/features/erg/components/ErgSkeleton.tsx
    src/v2/components/erg/ErgTestsTable.tsx
  </files>
  <action>
    **ErgTestsPage.tsx:**
    1. Replace auth loading spinner (lines 125-131) with a full-page skeleton that matches the page layout:
       - Header skeleton (title, buttons)
       - Filter bar skeleton
       - Table skeleton (using ErgTableSkeleton)
    2. Create a `ErgPageSkeleton` component inline or import from ErgSkeleton.tsx that renders:
       - A header area with skeleton blocks for title, count, and 3 action buttons
       - A filter bar with skeleton blocks for type dropdown and date range buttons
       - An ErgTableSkeleton for the main content area

    **ErgTestsTable.tsx:**
    3. Replace the loading spinner (lines 258-264, the `animate-spin rounded-full` div) with `<ErgTableSkeleton />` import from `@v2/features/erg/components/ErgSkeleton`
    4. Replace the mobile loading path to use `<ErgMobileListSkeleton />` when isMobile && isLoading

    **ErgSkeleton.tsx:**
    5. Add an `ErgPageSkeleton` export that renders the full page skeleton (header + filters + table)
    6. Ensure all existing skeletons (ErgTableSkeleton, ErgCardSkeleton, ErgMobileListSkeleton, ErgChartSkeleton) are properly exported

    Do NOT use `animate-spin` or `border-b-2` spinner patterns anywhere. All loading states must use react-loading-skeleton with theme-aware CSS custom properties (var(--color-bg-surface) for baseColor, var(--color-bg-hover) for highlightColor).
  </action>
  <verify>
    Run: `grep -rn "animate-spin" src/v2/pages/ErgTestsPage.tsx src/v2/components/erg/ErgTestsTable.tsx`
    Should return zero matches.
    Run: `npm run build` — should succeed.
  </verify>
  <done>
    ErgTestsPage shows skeleton loaders for auth loading state. ErgTestsTable shows ErgTableSkeleton for data loading (desktop) and ErgMobileListSkeleton for data loading (mobile). No spinners remain in any erg-related file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyboard shortcuts for erg test navigation and actions</name>
  <files>
    src/v2/hooks/useErgKeyboard.ts
    src/v2/pages/ErgTestsPage.tsx
  </files>
  <action>
    Create `src/v2/hooks/useErgKeyboard.ts` following the pattern from Phase 28's `useAthleteKeyboard.ts`:

    **useErgKeyboard.ts:**
    1. Accept props: `{ tests: ErgTest[], onEdit: (test) => void, onDelete: (testId) => void, enabled: boolean }`
    2. Track `selectedIndex` state (current highlighted row, -1 = none)
    3. Implement keyboard handlers:
       - `j` or `ArrowDown`: Move selection down (increment selectedIndex, wrap at end)
       - `k` or `ArrowUp`: Move selection up (decrement selectedIndex, wrap at start)
       - `e` or `Enter`: Edit selected test (call onEdit with tests[selectedIndex])
       - `Delete` or `Backspace`: Delete selected test (call onDelete with tests[selectedIndex].id)
       - `/`: Focus the test type filter (use document.getElementById)
       - `?`: Toggle keyboard shortcuts help overlay
       - `Escape`: Clear selection (set selectedIndex to -1)
    4. Add `shouldIgnoreEvent(event)` guard — skip when:
       - Target is input, textarea, select, or contenteditable
       - Dialog/modal is open (check for `[role="dialog"]` in DOM)
       - Cmd+K command palette is open
    5. Return: `{ selectedIndex, setSelectedIndex, showHelp, setShowHelp }`
    6. Use `useEffect` with global `keydown` listener, cleaned up on unmount.

    **ErgTestsPage.tsx integration:**
    7. Import and call `useErgKeyboard({ tests, onEdit: handleOpenEditModal, onDelete: handleDelete, enabled: !isModalOpen && !isImportModalOpen })`
    8. Pass `selectedIndex` to ErgTestsTable as a prop for visual highlight (add `selectedIndex?: number` to ErgTestsTableProps)
    9. Add a floating keyboard shortcuts help panel (shown when `showHelp` is true):
       - Small, fixed panel in bottom-right corner
       - Shows: J/K navigate, E edit, Del delete, / filter, ? help
       - Dismissible with ? or Escape
       - Uses glass-card styling from design system
    10. Update ErgTestsTable to highlight the row at `selectedIndex` with a subtle background (`bg-interactive-primary/5 ring-1 ring-interactive-primary/20`)
  </action>
  <verify>
    Run: `npm run build` — should succeed.
    Manual test: Load erg page, press J/K to navigate rows, E to edit, ? to see help overlay.
  </verify>
  <done>
    Erg tests page supports keyboard shortcuts: J/K navigate, E edit, Delete remove, / focus filters, ? show help. Shortcuts disabled when modal is open. Selected row is visually highlighted. Help overlay uses glass-card design.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "animate-spin" src/v2/pages/ErgTestsPage.tsx src/v2/components/erg/ErgTestsTable.tsx` — zero matches
2. `npm run build` passes
3. Keyboard shortcuts work: J/K, E, Delete, /, ?
4. Skeleton loaders render correctly during loading states
</verification>

<success_criteria>
- All loading states in erg feature use skeleton loaders (CW-03)
- Keyboard shortcuts work for navigation and actions (CW-02)
- Shortcuts are properly guarded (disabled in modals, inputs)
- Help overlay is discoverable and dismissible
</success_criteria>

<output>
After completion, create `.planning/phases/30-erg-data-migration/30-02-SUMMARY.md`
</output>
