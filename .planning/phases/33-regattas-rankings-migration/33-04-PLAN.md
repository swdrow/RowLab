---
phase: 33-regattas-rankings-migration
plan: 04
type: execute
wave: 2
depends_on: [33-01, 33-02]
files_modified:
  - src/v2/components/rankings/RankingsView.tsx
  - src/v2/components/rankings/RankingRow.tsx
  - src/v2/components/rankings/RankingTrendChart.tsx
  - src/v2/components/rankings/NCAAExportDialog.tsx
  - src/v2/components/rankings/index.ts
  - src/v2/components/regatta/ResultsForm.tsx
  - src/v2/pages/RankingsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User sees ranking rows smoothly animate to new positions when rankings update (Framer Motion layout)"
    - "User sees rank change indicators (up arrow green, down arrow red, dash neutral) per row"
    - "User sees speed-over-time sparkline trend per ranking row"
    - "User can export rankings in NCAA-compliant CSV format"
    - "User sees improved results entry UX with clearer input layout"
  artifacts:
    - path: "src/v2/components/rankings/RankingRow.tsx"
      provides: "Animated ranking row with trend indicator, rank change badge, and layout animation"
      min_lines: 60
    - path: "src/v2/components/rankings/RankingTrendChart.tsx"
      provides: "Inline speed-over-time sparkline for ranking rows"
      min_lines: 40
    - path: "src/v2/components/rankings/NCAAExportDialog.tsx"
      provides: "Dialog for exporting rankings in NCAA CSV format"
      min_lines: 60
  key_links:
    - from: "src/v2/components/rankings/RankingsView.tsx"
      to: "src/v2/components/rankings/RankingRow.tsx"
      via: "renders RankingRow per ranking entry with layout animation"
      pattern: "RankingRow"
    - from: "src/v2/components/rankings/RankingRow.tsx"
      to: "src/v2/components/rankings/RankingTrendChart.tsx"
      via: "renders inline sparkline per row"
      pattern: "RankingTrendChart"
    - from: "src/v2/pages/RankingsPage.tsx"
      to: "src/v2/components/rankings/NCAAExportDialog.tsx"
      via: "renders NCAA export dialog when export button clicked"
      pattern: "NCAAExportDialog"
---

<objective>
Add animated ranking visualizations, NCAA compliance export, and improved results entry UX.

Purpose: Fulfill REG-01 (improved results entry), RK-01 (animated ranking transitions), and RK-02 (NCAA compliance export). Rankings should feel like a live leaderboard with smooth FLIP animations when positions change. NCAA export enables coaches to submit rankings to governing bodies.

Output: Animated ranking rows with trend sparklines, NCAA export dialog, and polished results entry form.
</objective>

<execution_context>
@/home/swd/.claude/get-shit-done/workflows/execute-plan.md
@/home/swd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-regattas-rankings-migration/33-RESEARCH.md
@.planning/phases/33-regattas-rankings-migration/33-01-SUMMARY.md
@.planning/phases/33-regattas-rankings-migration/33-02-SUMMARY.md
@src/v2/utils/animations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Animated ranking rows with trend sparklines and rank change indicators</name>
  <files>
    src/v2/components/rankings/RankingRow.tsx
    src/v2/components/rankings/RankingTrendChart.tsx
    src/v2/components/rankings/RankingsView.tsx
    src/v2/components/rankings/index.ts
  </files>
  <action>
    Create animated ranking row components and integrate into RankingsView.

    **Step 1: Create `RankingRow.tsx`**

    Animated ranking row component following Phase 31 patterns (Framer Motion layout animations):

    - Props: `{ rank, teamName, speed, boatClass, previousRank?, sampleCount?, isHighlighted?, trendData? }`
    - Use `motion.div` with `layout` prop for FLIP position animation on rank changes
    - Use `SPRING_CONFIG` from animations.ts (stiffness 400, damping 17) for transition
    - Rank change indicator:
      - `previousRank > rank` (improved): TrendingUp icon in `text-data-excellent`, "+N" badge in `bg-data-excellent/10`
      - `previousRank < rank` (dropped): TrendingDown icon in `text-data-poor`, "-N" badge in `bg-data-poor/10`
      - No change: Minus icon in `text-txt-tertiary`
    - Highlight flash on recent changes: `backgroundColor` animates from warm amber (`rgba(245, 158, 11, 0.1)`) to transparent
    - Speed values in `font-mono tabular-nums`
    - V3 design tokens: `border-ink-border`, `hover:bg-ink-hover`, `text-txt-primary`

    **Step 2: Create `RankingTrendChart.tsx`**

    Inline sparkline for speed trend over time:

    - Props: `{ data: Array<{ date: string; speed: number }>, width?: number, height?: number }`
    - Use recharts `AreaChart` with `Area` (same pattern as ELO sparkline from Phase 31)
    - Default size: 80x32px (inline in table row)
    - Gradient fill under line using V3 data-excellent color for positive trend
    - No axes, labels, or grid lines (sparkline only)
    - Y-axis: auto-scaled to data range
    - If trendData is empty or undefined, render a dash or nothing

    **Step 3: Update `RankingsView.tsx`**

    Integrate animated rows into existing RankingsView:

    - Wrap ranking list in `<LayoutGroup>` from Framer Motion
    - Replace static table rows with `<RankingRow>` components
    - Wrap in `<AnimatePresence initial={false}>` for enter/exit animations
    - Use `key={ranking.teamId || ranking.id}` for stable animation keys
    - Performance optimization: Only animate top 20 rows (per RESEARCH.md Pitfall 5). Rows 21+ render without `layout` prop.
    - Add "Export for NCAA" button in the header area (wired in Task 2)

    **Step 4: Update `index.ts`**

    Export new components: `RankingRow`, `RankingTrendChart`, `NCAAExportDialog`.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Run `grep -n 'layout\|SPRING_CONFIG\|LayoutGroup' src/v2/components/rankings/RankingRow.tsx` to verify animation integration.
    Run `grep -n 'AreaChart\|recharts' src/v2/components/rankings/RankingTrendChart.tsx` to verify sparkline implementation.
  </verify>
  <done>
    RankingRow animates position changes with spring physics. RankingTrendChart shows inline sparkline. RankingsView integrates animated rows with performance optimization for large datasets. Top 20 rows animate, remaining rows render statically.
  </done>
</task>

<task type="auto">
  <name>Task 2: NCAA export dialog and improved results entry</name>
  <files>
    src/v2/components/rankings/NCAAExportDialog.tsx
    src/v2/components/regatta/ResultsForm.tsx
    src/v2/pages/RankingsPage.tsx
  </files>
  <action>
    Create NCAA compliance export and polish the results entry UX.

    **Step 1: Create `NCAAExportDialog.tsx`**

    Dialog for exporting rankings in NCAA-compliant CSV format (per RESEARCH.md Pattern 5):

    - Props: `{ isOpen: boolean, onClose: () => void, rankings: Ranking[] }`
    - Use Headless UI `Dialog` with glass-card panel
    - Export format: CSV with headers: Institution, Boat Class, Rank, Speed (m/s), Sample Size, Last Updated
    - Use `date-fns format()` for date formatting (yyyy-MM-dd)
    - Generate CSV as Blob and trigger download via anchor element
    - File name: `ncaa-rankings-YYYY-MM-DD.csv`
    - Show preview info: number of teams, date range, boat class
    - Download button with Download icon (lucide-react)
    - Cancel button
    - Show success toast via `sonner` on export
    - V3 design tokens: `glass-card`, `bg-accent-copper` for download button, `bg-ink-raised` for preview info area
    - Motion animation for dialog enter/exit using `MODAL_VARIANTS` from animations.ts

    **Step 2: Wire NCAAExportDialog into RankingsPage.tsx**

    - Add "Export for NCAA" button near the rankings header
    - State: `const [showExport, setShowExport] = useState(false)`
    - Button: `<button onClick={() => setShowExport(true)}>` with FileSpreadsheet icon
    - Render `<NCAAExportDialog isOpen={showExport} onClose={() => setShowExport(false)} rankings={rankings} />`

    **Step 3: Polish ResultsForm.tsx**

    Improve the results entry UX (REG-01):

    - Ensure all form inputs use V3 tokens (already migrated in Plan 01, but verify and enhance)
    - Add clearer visual hierarchy: section headers for "Race Details" vs "Results"
    - Place/time inputs should use `font-mono tabular-nums` for alignment
    - Add inline validation feedback with `text-data-poor` for errors
    - Improve the submit flow: optimistic success with `toast.success('Result saved')`
    - Ensure the form uses `bg-ink-well` for input fields and `border-ink-border` for borders
    - If the form has multiple result rows (batch entry), ensure visual separation between rows with `border-ink-border divide-y`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Run `grep -n 'NCAAExportDialog\|Export for NCAA' src/v2/pages/RankingsPage.tsx` to verify dialog is wired.
    Run `grep -n 'csv\|Blob\|download' src/v2/components/rankings/NCAAExportDialog.tsx` to verify CSV export logic.
  </verify>
  <done>
    NCAA export dialog generates valid CSV with all required fields. Export button is visible on Rankings page. Results entry form has polished V3 styling with clear visual hierarchy and inline validation feedback.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- RankingRow has Framer Motion layout animations
- NCAAExportDialog generates downloadable CSV
- ResultsForm uses V3 tokens with improved UX
</verification>

<success_criteria>
Rankings animate with spring physics when positions change. Trend sparklines show speed history inline. NCAA export dialog generates valid CSV for compliance submission. Results entry form is polished with V3 design tokens and clear visual hierarchy.
</success_criteria>

<output>
After completion, create `.planning/phases/33-regattas-rankings-migration/33-04-SUMMARY.md`
</output>
