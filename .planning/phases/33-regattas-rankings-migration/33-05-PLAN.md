---
phase: 33-regattas-rankings-migration
plan: 05
type: execute
wave: 3
depends_on: [33-03, 33-04]
files_modified:
  - src/v2/hooks/useRegattaKeyboard.ts
  - src/v2/hooks/useRegattas.ts
  - src/v2/hooks/useRaces.ts
  - src/v2/features/regatta/components/RegattaSkeleton.tsx
  - src/v2/features/regatta/components/RankingsSkeleton.tsx
  - src/v2/features/regatta/components/OfflineQueueIndicator.tsx
  - src/v2/pages/RegattasPage.tsx
  - src/v2/pages/RankingsPage.tsx
  - src/v2/components/regatta/RegattaDetail.tsx
  - src/v2/components/rankings/RankingsView.tsx
autonomous: true

must_haves:
  truths:
    - "User can press N to create new regatta, R to refresh, ? for help overlay, Escape to close panels"
    - "User sees keyboard shortcut hints in help overlay listing all available regatta/ranking shortcuts"
    - "All regatta mutations (create/update/delete regatta, race, result) use optimistic UI"
    - "User sees skeleton loaders matching final layout when regatta/ranking data is loading"
    - "User never sees a spinner on any regatta or rankings page"
    - "User sees live erg data via WebSocket replacing polling (RT-01)"
    - "User's offline mutations queue and sync automatically on reconnect (RT-04)"
  artifacts:
    - path: "src/v2/hooks/useRegattaKeyboard.ts"
      provides: "Keyboard shortcut handler for regatta and rankings pages"
      min_lines: 50
    - path: "src/v2/features/regatta/components/RegattaSkeleton.tsx"
      provides: "Skeleton loader matching regatta list and detail layout"
      min_lines: 40
    - path: "src/v2/features/regatta/components/RankingsSkeleton.tsx"
      provides: "Skeleton loader matching rankings table layout"
      min_lines: 30
    - path: "src/v2/features/regatta/components/OfflineQueueIndicator.tsx"
      provides: "Small badge showing pending offline mutations count"
      min_lines: 30
  key_links:
    - from: "src/v2/hooks/useRegattaKeyboard.ts"
      to: "src/v2/pages/RegattasPage.tsx"
      via: "useRegattaKeyboard hook call in page component"
      pattern: "useRegattaKeyboard"
    - from: "src/v2/pages/RegattasPage.tsx"
      to: "src/v2/features/regatta/components/RegattaSkeleton.tsx"
      via: "renders skeleton when data is loading"
      pattern: "RegattaSkeleton"
    - from: "src/v2/hooks/useRegattas.ts"
      to: "optimistic update"
      via: "onMutate callback with queryClient.setQueryData"
      pattern: "onMutate.*cancelQueries"
    - from: "src/v2/features/regatta/components/OfflineQueueIndicator.tsx"
      to: "navigator.onLine"
      via: "monitors online/offline state for queue display"
      pattern: "navigator\\.onLine"
---

<objective>
Add cross-cutting concerns: keyboard shortcuts, optimistic UI, skeleton loaders, and offline mutation queue for regattas and rankings.

Purpose: Fulfill CW-01 (optimistic UI), CW-02 (keyboard shortcuts), CW-03 (skeleton loaders), RT-01 (WebSocket replaces polling for live erg data during regattas), and RT-04 (offline mutation queue with auto-sync). These cross-cutting requirements apply to every v3.0 phase and ensure consistent UX patterns across the app.

Output: Keyboard shortcut hook, skeleton loaders, optimistic mutations on all hooks, and offline queue indicator.
</objective>

<execution_context>
@/home/swd/.claude/get-shit-done/workflows/execute-plan.md
@/home/swd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-regattas-rankings-migration/33-RESEARCH.md
@.planning/phases/33-regattas-rankings-migration/33-03-SUMMARY.md
@.planning/phases/33-regattas-rankings-migration/33-04-SUMMARY.md
@src/v2/hooks/useRegattas.ts
@src/v2/hooks/useRaces.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Keyboard shortcuts and optimistic UI audit for regatta/ranking mutations</name>
  <files>
    src/v2/hooks/useRegattaKeyboard.ts
    src/v2/hooks/useRegattas.ts
    src/v2/hooks/useRaces.ts
    src/v2/pages/RegattasPage.tsx
    src/v2/pages/RankingsPage.tsx
  </files>
  <action>
    **Step 1: Create `useRegattaKeyboard.ts`**

    Keyboard shortcut hook following the Phase 32 `useTrainingKeyboard` pattern:

    - Accept `{ onNewRegatta, onRefresh, onToggleHelp }` callbacks
    - Register global keydown listener with `shouldIgnoreEvent` guard (skip if in input, textarea, dialog, or cmdk)
    - Shortcuts:
      - `N` -> Create new regatta (calls `onNewRegatta`)
      - `R` -> Refresh data (calls `onRefresh`)
      - `?` -> Toggle help overlay (calls `onToggleHelp`)
      - `Escape` -> Close active panel/dialog
      - `E` -> Export rankings (only on rankings page)
    - Help overlay content: array of `{ key, description }` objects for rendering
    - Clean up event listener on unmount

    **Step 2: Wire keyboard shortcuts into pages**

    In `RegattasPage.tsx`:
    - Import and call `useRegattaKeyboard({ onNewRegatta: () => setShowCreateForm(true), onRefresh: () => queryClient.invalidateQueries({ queryKey: queryKeys.regattas.all }), onToggleHelp: () => setShowHelp(!showHelp) })`
    - Render help overlay when `showHelp` is true (modal listing shortcuts)

    In `RankingsPage.tsx`:
    - Wire `useRegattaKeyboard` with rankings-specific callbacks
    - `E` -> open NCAA export dialog

    **Step 3: Optimistic UI audit on `useRegattas.ts`**

    Review all mutations in `useRegattas.ts` and ensure they follow the optimistic update pattern:

    For each mutation (create, update, delete regatta):
    ```typescript
    onMutate: async (variables) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: queryKeys.regattas.lists() });
      // Snapshot previous value
      const previous = queryClient.getQueryData(queryKeys.regattas.lists());
      // Optimistically update cache
      queryClient.setQueryData(queryKeys.regattas.lists(), (old) => {
        // Add/update/remove item
      });
      return { previous };
    },
    onError: (err, variables, context) => {
      // Rollback on error
      queryClient.setQueryData(queryKeys.regattas.lists(), context?.previous);
      toast.error('Failed to save changes');
    },
    onSettled: () => {
      // Always refetch after mutation settles
      queryClient.invalidateQueries({ queryKey: queryKeys.regattas.all });
    },
    ```

    If mutations already have optimistic updates, verify they follow the correct pattern. If not, add them.

    **Step 4: Optimistic UI audit on `useRaces.ts`**

    Same pattern as Step 3 for race mutations (create race, add result, update result, delete result).

    For result mutations, also emit `raceday:result:submit` via the socket (if connected) so other users see the update in real-time.

    **Step 5: Add `networkMode: 'offlineFirst'` to mutations**

    In `useRegattas.ts` and `useRaces.ts`, set `networkMode: 'offlineFirst'` on mutations that should queue while offline (per RT-04). This tells TanStack Query to queue the mutation and retry when online.

    ```typescript
    useMutation({
      mutationFn: createRegatta,
      networkMode: 'offlineFirst', // Queue while offline
      retry: 3,
      // ... optimistic updates
    })
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Run `grep -n 'useRegattaKeyboard' src/v2/pages/RegattasPage.tsx src/v2/pages/RankingsPage.tsx` to verify hook is wired.
    Run `grep -n 'onMutate\|onError\|onSettled\|optimistic' src/v2/hooks/useRegattas.ts src/v2/hooks/useRaces.ts` to verify optimistic updates.
    Run `grep -n 'networkMode.*offlineFirst' src/v2/hooks/useRegattas.ts src/v2/hooks/useRaces.ts` to verify offline support.
  </verify>
  <done>
    Keyboard shortcuts work on regatta and rankings pages. All regatta/race mutations use optimistic UI with proper rollback. Mutations queue while offline via `networkMode: 'offlineFirst'`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Skeleton loaders and offline queue indicator</name>
  <files>
    src/v2/features/regatta/components/RegattaSkeleton.tsx
    src/v2/features/regatta/components/RankingsSkeleton.tsx
    src/v2/features/regatta/components/OfflineQueueIndicator.tsx
    src/v2/pages/RegattasPage.tsx
    src/v2/pages/RankingsPage.tsx
    src/v2/components/regatta/RegattaDetail.tsx
    src/v2/components/rankings/RankingsView.tsx
  </files>
  <action>
    Create skeleton loaders and offline queue indicator, then wire them into pages.

    **Step 1: Create `RegattaSkeleton.tsx`**

    Skeleton loader matching the regatta list and detail layout:

    - `RegattaListSkeleton`: 5 rows matching regatta card layout (name, date, location shimmer blocks)
    - `RegattaDetailSkeleton`: Race timeline skeleton (header + 4 race cards with result placeholders)
    - Use shimmer animation with `animate-pulse` or CSS shimmer effect
    - Match the exact layout dimensions of real components (same padding, spacing, height)
    - Use `bg-ink-raised` for skeleton block backgrounds with `opacity-50`

    **Step 2: Create `RankingsSkeleton.tsx`**

    Skeleton loader matching the rankings table layout:

    - Table header skeleton (6 columns matching real headers)
    - 10 rows with rank number, team name, speed, trend sparkline placeholders
    - Match column widths of real RankingsView table

    **Step 3: Create `OfflineQueueIndicator.tsx`**

    Small, persistent badge showing pending offline mutations (RT-04):

    - Shows when `pendingCount > 0` and `!navigator.onLine`
    - Badge text: "{N} pending" or "Syncing..." when online and mutations retrying
    - Uses `bg-data-warning/10 text-data-warning` when offline
    - Uses `bg-data-good/10 text-data-good` when syncing
    - Position: Fixed bottom-left or bottom-right corner
    - Listens to `online`/`offline` window events
    - Gets pending count from TanStack Query mutation cache:
      ```typescript
      const pendingCount = queryClient.getMutationCache().getAll()
        .filter(m => m.state.status === 'pending').length;
      ```
    - Auto-hide when `pendingCount === 0` and online

    **Step 4: Wire skeletons into pages**

    In `RegattasPage.tsx`:
    - Replace any spinner/loading indicator with `<RegattaListSkeleton />`
    - Show skeleton during `isLoading` state from `useRegattas`
    - Verify NO spinners remain (search for "spinner", "loading", "Spinner", "CircularProgress")

    In `RankingsPage.tsx`:
    - Replace any loading indicator with `<RankingsSkeleton />`

    In `RegattaDetail.tsx`:
    - Use `<RegattaDetailSkeleton />` during detail loading

    In `RankingsView.tsx`:
    - Use `<RankingsSkeleton />` during initial data load

    **Step 5: Wire OfflineQueueIndicator**

    Render `<OfflineQueueIndicator />` in `RegattasPage.tsx` and `RankingsPage.tsx` (or in a shared layout wrapper if one exists for these pages). It should always be visible during race day when mutations are queued.

    **Step 6: Integrate ConnectionIndicator from Plan 03**

    Add `<ConnectionIndicator />` to `RegattaDetail.tsx` header area when viewing an active regatta. Use `useConnectionHealth()` from Plan 03 to get the status.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles.
    Run `grep -rn 'spinner\|Spinner\|CircularProgress\|loading.*spin' src/v2/pages/RegattasPage.tsx src/v2/pages/RankingsPage.tsx src/v2/components/regatta/RegattaDetail.tsx src/v2/components/rankings/RankingsView.tsx` â€” should return zero matches (no spinners).
    Run `grep -n 'RegattaSkeleton\|RankingsSkeleton\|OfflineQueueIndicator\|ConnectionIndicator' src/v2/pages/RegattasPage.tsx src/v2/pages/RankingsPage.tsx src/v2/components/regatta/RegattaDetail.tsx` to verify all are wired.
  </verify>
  <done>
    Skeleton loaders replace all spinners on regatta and ranking pages. OfflineQueueIndicator shows pending mutation count when offline. ConnectionIndicator shows live status on regatta detail pages. Zero spinners remain across all regatta/ranking views.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Zero spinners remain in regatta/ranking pages
- Keyboard shortcuts functional (N, R, ?, Escape, E)
- All mutations have optimistic updates with rollback
- Offline queue indicator shows pending count
- Connection health indicator appears on regatta detail
</verification>

<success_criteria>
All cross-cutting requirements (CW-01, CW-02, CW-03, RT-01, RT-04) are fulfilled for the regattas/rankings domain. Keyboard shortcuts, optimistic UI, skeleton loaders, offline queue, and connection health indicator are all wired and functional.
</success_criteria>

<output>
After completion, create `.planning/phases/33-regattas-rankings-migration/33-05-SUMMARY.md`
</output>
