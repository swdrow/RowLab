// Prisma schema for RowLab v2.0
// PostgreSQL with multi-tenant team isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE: Users, Teams, Membership
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String?  @unique // Optional for admin accounts
  username     String?  @unique // For admin accounts (non-email login)
  passwordHash String
  name         String
  isAdmin      Boolean  @default(false) // Admin accounts have special privileges
  status       String   @default("active") // active, suspended
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  memberships            TeamMember[]
  refreshTokens          RefreshToken[]
  announcements          Announcement[]
  settings               UserSettings?
  concept2Auth           Concept2Auth?
  stravaAuth             StravaAuth?
  boatSessions           BoatSession[]
  createdPlans           TrainingPlan[]        @relation("PlanCreator")
  assignedPlans          WorkoutAssignment[]   @relation("PlanAssigner")
  dashboardPreferences   DashboardPreferences?
  whiteboards            Whiteboard[]
  createdSessions        Session[]             @relation("SessionCreator")
  attendanceOverrides    SessionAttendance[]   @relation("AttendanceOverrides")
  createdRecruitVisits   RecruitVisit[]
  draftedLineups         Lineup[]              @relation("lineupDrafts")

  @@map("users")
}

model Team {
  id                String   @id @default(uuid())
  name              String
  slug              String   @unique
  inviteCode        String?  @unique
  isPublic          Boolean  @default(false)
  visibilitySetting String   @default("coaches_only") // open, coaches_only, opt_in
  settings          Json     @default("{}")
  aiModel           String? // Preferred AI model (e.g., "phi4-mini-reasoning:3.8b")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members             TeamMember[]
  athletes            Athlete[]
  invitations         Invitation[]
  lineups             Lineup[]
  ergTests            ErgTest[]
  workouts            Workout[]
  announcements       Announcement[]
  shells              Shell[]
  oarSets             OarSet[]
  boatConfigs         BoatConfig[]
  seatRaceSessions    SeatRaceSession[]
  regattas            Regatta[]
  teamSpeedEstimates  TeamSpeedEstimate[]
  subscription        Subscription?
  calendarEvents      CalendarEvent[]
  waterSessions       WaterSession[]
  trainingPlans       TrainingPlan[]
  whiteboards         Whiteboard[]
  attendance          Attendance[]
  checklistTemplates  ChecklistTemplate[]
  externalRankings    ExternalRanking[]
  sessions            Session[]
  passiveObservations PassiveObservation[]
  recruitVisits       RecruitVisit[]
  challenges          Challenge[]
  riggingProfiles     RiggingProfile[]
  lineupTemplates     LineupTemplate[]
  equipmentAssignments EquipmentAssignment[]

  @@map("teams")
}

model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  role      String // OWNER, COACH, ATHLETE
  createdAt DateTime @default(now())

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  team               Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  workoutAssignments WorkoutAssignment[]
  workoutCompletions WorkoutCompletion[]

  @@unique([userId, teamId])
  @@map("team_members")
}

// ============================================
// AUTH: Tokens, Invitations
// ============================================

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  familyId  String // For rotation detection
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@map("refresh_tokens")
}

model Invitation {
  id        String   @id @default(uuid())
  teamId    String
  athleteId String? // For claim flow
  email     String
  tokenHash String   @unique // SHA-256 of actual token
  expiresAt DateTime
  status    String   @default("pending") // pending, claimed, expired, revoked
  createdAt DateTime @default(now())

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athlete Athlete? @relation(fields: [athleteId], references: [id])

  @@index([tokenHash])
  @@map("invitations")
}

// ============================================
// ATHLETES: Profiles (managed or linked)
// ============================================

model Athlete {
  id             String   @id @default(uuid())
  teamId         String
  userId         String? // NULL = managed by coach
  firstName      String
  lastName       String
  email          String? // For invites
  side           String? // Port, Starboard, Both, Cox
  canScull       Boolean  @default(false)
  canCox         Boolean  @default(false)
  isManaged      Boolean  @default(true)
  concept2UserId String?
  weightKg       Decimal? @db.Decimal(5, 2)
  heightCm       Int?
  country        String? // ISO 3166-1 alpha-3 country code (e.g., USA, GBR)
  avatar         String?  @db.Text // Base64 encoded image data URL
  gamificationEnabled Boolean @default(true) // Per-athlete opt-out
  status         String   @default("active") // active, inactive, injured, graduated
  classYear      Int?     // Graduation year (e.g., 2027), nullable for non-college programs
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  team                Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ergTests            ErgTest[]
  workouts            Workout[]
  assignments         LineupAssignment[]
  invitations         Invitation[]
  athleteRatings      AthleteRating[]
  telemetryData       AthleteTelemetry[]
  seatRaceAssignments SeatRaceAssignment[]
  availability        Availability[]
  defaultSchedule     DefaultSchedule?
  attendance          Attendance[]
  sessionAttendance   SessionAttendance[]
  passiveSwapsAs1     PassiveObservation[] @relation("PassiveSwap1")
  passiveSwapsAs2     PassiveObservation[] @relation("PassiveSwap2")
  recruitVisits       RecruitVisit[]
  achievements        AthleteAchievement[]
  challengeParticipations ChallengeParticipant[]
  personalRecords     PersonalRecord[]

  @@unique([teamId, lastName, firstName])
  @@index([teamId])
  @@map("athletes")
}

// ============================================
// AVAILABILITY: Athlete scheduling
// ============================================

model Availability {
  id          String           @id @default(uuid())
  athleteId   String
  date        DateTime
  morningSlot AvailabilitySlot @default(NOT_SET)
  eveningSlot AvailabilitySlot @default(NOT_SET)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, date])
  @@index([athleteId])
  @@index([date])
  @@map("availability")
}

model DefaultSchedule {
  id        String   @id @default(uuid())
  athleteId String   @unique
  schedule  Json // { monday: { morning: "AVAILABLE", evening: "UNAVAILABLE" }, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@map("default_schedules")
}

// ============================================
// ATTENDANCE: Daily practice attendance tracking
// ============================================

model Attendance {
  id              String   @id @default(uuid())
  teamId          String
  athleteId       String
  date            DateTime @db.Date
  status          String // present, late, excused, unexcused
  durationMinutes Int? // For NCAA hour tracking
  notes           String?
  recordedBy      String? // userId who recorded
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, date])
  @@index([teamId, date])
  @@index([athleteId])
  @@map("attendance")
}

// ============================================
// WHITEBOARD: Daily team communications
// ============================================

model Whiteboard {
  id        String   @id @default(uuid())
  teamId    String
  date      DateTime
  content   String   @db.Text
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])

  @@unique([teamId, date])
  @@index([teamId])
  @@index([date])
  @@map("whiteboards")
}

// ============================================
// DASHBOARD: User preferences and activity feed
// ============================================

model DashboardPreferences {
  id            String   @id @default(uuid())
  userId        String   @unique
  pinnedModules Json     @default("[]") // Array of module IDs
  hiddenSources Json     @default("[]") // Array of ActivitySource values
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dashboard_preferences")
}

model Activity {
  id           String         @id @default(uuid())
  userId       String
  teamId       String?
  source       ActivitySource
  sourceId     String // Unique ID from source system
  activityType String? // erg, row, strength, etc.
  title        String
  description  String?        @db.Text
  date         DateTime
  data         Json? // Source-specific data
  createdAt    DateTime       @default(now())

  @@unique([source, sourceId]) // Prevent duplicates from same source
  @@index([userId])
  @@index([teamId])
  @@index([date])
  @@map("activities")
}

model Concept2Auth {
  userId         String    @id
  c2UserId       String
  username       String? // Concept2 username
  accessToken    String    @db.Text // OAuth access token (encrypted)
  refreshToken   String    @db.Text // OAuth refresh token (encrypted)
  tokenExpiresAt DateTime
  lastSyncedAt   DateTime?
  syncEnabled    Boolean   @default(true) // Auto-sync on webhook
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([c2UserId])
  @@map("concept2_auth")
}

model StravaAuth {
  userId          String    @id
  stravaAthleteId BigInt // Strava athlete ID
  username        String? // Strava username/display name
  accessToken     String    @db.Text // OAuth access token (encrypted)
  refreshToken    String    @db.Text // OAuth refresh token (encrypted)
  tokenExpiresAt  DateTime
  lastSyncedAt    DateTime?
  syncEnabled     Boolean   @default(true) // Auto-sync from Strava to RowLab
  scope           String? // OAuth scopes granted
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // C2 to Strava sync settings
  c2ToStravaEnabled Boolean   @default(false) // Master toggle for C2→Strava uploads
  c2ToStravaTypes   Json      @default("{}") // Activity types to sync: {"rower": true, "bikeerg": false, ...}
  lastC2SyncedAt    DateTime? // Last C2→Strava sync timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stravaAthleteId])
  @@map("strava_auth")
}

// ============================================
// ERG DATA: Tests and Workouts
// ============================================

model ErgTest {
  id           String   @id @default(uuid())
  athleteId    String
  teamId       String
  testType     String // 2k, 6k, 30min, 500m
  testDate     DateTime
  distanceM    Int?
  timeSeconds  Decimal  @db.Decimal(10, 1)
  splitSeconds Decimal? @db.Decimal(6, 1)
  watts        Int?
  strokeRate   Int?
  weightKg     Decimal? @db.Decimal(5, 2) // Weight at time of test
  notes        String?
  createdAt    DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([athleteId])
  @@map("erg_tests")
}

model Workout {
  id               String   @id @default(uuid())
  athleteId        String? // Optional - may be synced by user without athlete record
  userId           String? // For user-level syncs (Strava, etc.)
  teamId           String
  source           String // manual, concept2_sync, strava_sync, csv_import, bluetooth, fit_import
  type             String? // on_water, erg, strength, cardio, other
  c2LogbookId      String?  @unique
  stravaActivityId String?  @unique
  date             DateTime
  distanceM        Int?
  durationSeconds  Decimal? @db.Decimal(10, 1)
  strokeRate       Int?
  calories         Int?
  dragFactor       Int?
  machineType      String? // rower, bikerg, skierg (from C2 API workout_type field)
  avgPace          Decimal? @db.Decimal(8, 1) // avg pace in tenths of seconds per 500m
  avgWatts         Int? // average watts
  avgHeartRate     Int? // average heart rate
  notes            String?  @db.Text // user-editable notes field
  deviceInfo       Json?
  rawData          Json?
  createdAt        DateTime @default(now())

  athlete     Athlete?            @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  team        Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  telemetry   WorkoutTelemetry?
  completions WorkoutCompletion[]
  splits      WorkoutSplit[]

  @@index([teamId])
  @@index([athleteId])
  @@index([userId])
  @@map("workouts")
}

model WorkoutTelemetry {
  workoutId        String    @id
  timeSeriesS      Decimal[] @db.Decimal(10, 1)
  wattsSeries      Int[]
  heartRateSeries  Int[]
  strokeRateSeries Int[]
  forceCurves      Json?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@map("workout_telemetry")
}

model WorkoutSplit {
  id           String   @id @default(uuid())
  workoutId    String
  splitNumber  Int // 1-indexed split number
  distanceM    Int?
  timeSeconds  Decimal? @db.Decimal(10, 1)
  pace         Decimal? @db.Decimal(8, 1) // pace in tenths of seconds per 500m
  watts        Int?
  strokeRate   Int?
  heartRate    Int?
  dragFactor   Int?
  calories     Int?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@unique([workoutId, splitNumber])
  @@index([workoutId])
  @@map("workout_splits")
}

// ============================================
// LINEUPS: Boat assignments
// ============================================

model Lineup {
  id          String    @id @default(uuid())
  teamId      String
  name        String
  notes       String?
  status      String    @default("published") // "draft" or "published"
  draftedBy   String? // userId of coach who last edited the draft
  publishedAt DateTime? // when lineup was last published
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team                 Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  draftedByUser        User?                 @relation("lineupDrafts", fields: [draftedBy], references: [id], onDelete: SetNull)
  assignments          LineupAssignment[]
  raceResults          RaceResult[]
  equipmentAssignments EquipmentAssignment[]

  @@index([teamId])
  @@index([teamId, status])
  @@map("lineups")
}

model LineupAssignment {
  id         String  @id @default(uuid())
  lineupId   String
  athleteId  String
  boatClass  String
  shellName  String?
  seatNumber Int
  side       String // Port, Starboard
  isCoxswain Boolean @default(false)

  lineup  Lineup  @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  athlete Athlete @relation(fields: [athleteId], references: [id])

  @@map("lineup_assignments")
}

// ============================================
// ENUMS: Equipment and Availability
// ============================================

enum ShellType {
  EIGHT
  FOUR
  QUAD
  DOUBLE
  PAIR
  SINGLE
}

enum WeightClass {
  HEAVYWEIGHT
  LIGHTWEIGHT
  OPENWEIGHT
}

enum RiggingType {
  SWEEP
  SCULL
}

enum OarType {
  SWEEP
  SCULL
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum AvailabilitySlot {
  AVAILABLE
  UNAVAILABLE
  MAYBE
  NOT_SET
}

enum ActivitySource {
  CONCEPT2
  STRAVA
  MANUAL
  CALENDAR
  WATER_SESSION
}

model Shell {
  id          String          @id @default(uuid())
  teamId      String
  name        String
  boatClass   String
  type        ShellType
  weightClass WeightClass
  rigging     RiggingType
  status      EquipmentStatus @default(AVAILABLE)
  notes       String?

  team            Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  riggingProfile  RiggingProfile?
  assignments     EquipmentAssignment[]

  @@unique([teamId, name])
  @@map("shells")
}

model OarSet {
  id     String          @id @default(uuid())
  teamId String
  name   String
  type   OarType
  count  Int
  status EquipmentStatus @default(AVAILABLE)
  notes  String?

  team        Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignments EquipmentAssignment[]

  @@unique([teamId, name])
  @@map("oar_sets")
}

model BoatConfig {
  id          String  @id @default(uuid())
  teamId      String
  name        String // e.g., "Varsity 8+"
  numSeats    Int
  hasCoxswain Boolean

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("boat_configs")
}

// ============================================
// COMMUNICATION: Announcements
// ============================================

model Announcement {
  id        String   @id @default(uuid())
  teamId    String
  authorId  String
  title     String
  content   String
  priority  String   @default("normal") // normal, important, urgent
  visibleTo String   @default("all") // all, athletes, coaches
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team   Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User               @relation(fields: [authorId], references: [id])
  reads  AnnouncementRead[]

  @@index([teamId])
  @@map("announcements")
}

model AnnouncementRead {
  announcementId String
  userId         String
  readAt         DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@id([announcementId, userId])
  @@map("announcement_reads")
}

// ============================================
// SEAT RACING: Selection system
// ============================================

model SeatRaceSession {
  id          String   @id @default(uuid())
  teamId      String
  date        DateTime
  location    String?
  conditions  String? // calm, variable, rough
  boatClass   String // 8+, 4+, 4-, 2-
  description String?
  createdAt   DateTime @default(now())

  team   Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  pieces SeatRacePiece[]

  @@index([teamId])
  @@map("seat_race_sessions")
}

model SeatRacePiece {
  id             String  @id @default(uuid())
  sessionId      String
  sequenceOrder  Int
  distanceMeters Int?
  direction      String? // upstream, downstream
  notes          String?

  session SeatRaceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  boats   SeatRaceBoat[]

  @@map("seat_race_pieces")
}

model SeatRaceBoat {
  id                String   @id @default(uuid())
  pieceId           String
  name              String // "Boat A", "Boat B"
  shellName         String?
  finishTimeSeconds Decimal? @db.Decimal(10, 2)
  handicapSeconds   Decimal  @default(0) @db.Decimal(5, 2)

  piece       SeatRacePiece        @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  assignments SeatRaceAssignment[]

  @@map("seat_race_boats")
}

model SeatRaceAssignment {
  id         String @id @default(uuid())
  boatId     String
  athleteId  String
  seatNumber Int // 1=Bow, 8=Stroke, 9=Cox
  side       String // Port, Starboard, Cox

  boat    SeatRaceBoat @relation(fields: [boatId], references: [id], onDelete: Cascade)
  athlete Athlete      @relation(fields: [athleteId], references: [id])

  @@map("seat_race_assignments")
}

model AthleteRating {
  id               String   @id @default(uuid())
  athleteId        String
  teamId           String
  ratingType       String // seat_race_elo, combined
  ratingValue      Decimal  @default(1000) @db.Decimal(8, 2)
  confidenceScore  Decimal? @db.Decimal(4, 3)
  racesCount       Int      @default(0)
  lastCalculatedAt DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, ratingType])
  @@map("athlete_ratings")
}

// Passive ELO observation from practice data
model PassiveObservation {
  id                    String   @id @default(cuid())
  teamId                String
  sessionId             String? // Link to Phase 13 Session if available
  pieceId               String? // Link to specific piece
  boat1Athletes         String[] // Athletes in boat 1 (stored as JSON array)
  boat2Athletes         String[] // Athletes in boat 2
  swappedAthlete1Id     String // Athlete unique to boat 1
  swappedAthlete2Id     String // Athlete unique to boat 2
  splitDifferenceSeconds Float // Positive = boat1 faster
  weight                Float   @default(0.5) // Weight factor (0.5 for practice, 1.0 for formal)
  source                String  @default("manual") // 'auto_detect', 'manual', 'split_observation'
  appliedToRatings      Boolean @default(false)
  appliedAt             DateTime?
  createdAt             DateTime @default(now())

  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  session         Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  swappedAthlete1 Athlete  @relation("PassiveSwap1", fields: [swappedAthlete1Id], references: [id])
  swappedAthlete2 Athlete  @relation("PassiveSwap2", fields: [swappedAthlete2Id], references: [id])

  @@index([teamId])
  @@index([sessionId])
  @@index([appliedToRatings])
  @@map("passive_observations")
}

// ============================================
// TELEMETRY: Oarlock/sensor data
// ============================================

model AthleteTelemetry {
  id             String   @id @default(uuid())
  athleteId      String
  sessionDate    DateTime
  source         String // empower, peach, nk
  seatNumber     Int?
  avgWatts       Decimal? @db.Decimal(6, 2)
  peakWatts      Decimal? @db.Decimal(6, 2)
  workPerStroke  Decimal? @db.Decimal(8, 2)
  slipDegrees    Decimal? @db.Decimal(5, 2)
  washDegrees    Decimal? @db.Decimal(5, 2)
  catchAngle     Decimal? @db.Decimal(5, 2)
  finishAngle    Decimal? @db.Decimal(5, 2)
  peakForceAngle Decimal? @db.Decimal(5, 2)
  techScore      Decimal? @db.Decimal(5, 2)
  createdAt      DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@map("athlete_telemetry")
}

// ============================================
// RACING: Regattas, Races, Results
// ============================================

model Regatta {
  id          String    @id @default(uuid())
  teamId      String
  name        String
  location    String?
  date        DateTime
  endDate     DateTime? // For multi-day regattas
  host        String? // Hosting organization
  venueType   String? // lake, river, etc.
  courseType  String? // 2000m, 1500m, head
  conditions  Json? // wind, temp, current
  description String?
  externalUrl String? // RegattaCentral/Row2k link
  teamGoals   String? // Pre-regatta notes
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  events Event[]
  races  Race[] // Keep for backward compatibility during migration

  @@index([teamId])
  @@map("regattas")
}

model Event {
  id           String   @id @default(uuid())
  regattaId    String
  name         String // "Varsity 8+", "2V8+", "JV4+", etc.
  category     String? // Predefined or custom category
  scheduledDay Int? // Day number for multi-day regattas (1, 2, 3)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  regatta Regatta @relation(fields: [regattaId], references: [id], onDelete: Cascade)
  races   Race[]

  @@index([regattaId])
  @@map("events")
}

model Race {
  id             String    @id @default(uuid())
  regattaId      String // Keep for backward compatibility
  eventId        String? // Optional during migration
  eventName      String
  boatClass      String
  distanceMeters Int       @default(2000)
  isHeadRace     Boolean   @default(false)
  scheduledTime  DateTime?

  regatta   Regatta        @relation(fields: [regattaId], references: [id], onDelete: Cascade)
  event     Event?         @relation(fields: [eventId], references: [id])
  results   RaceResult[]
  checklist RaceChecklist?

  @@index([eventId])
  @@map("races")
}

model RaceResult {
  id                String   @id @default(uuid())
  raceId            String
  teamName          String
  isOwnTeam         Boolean  @default(false)
  lineupId          String?
  finishTimeSeconds Decimal? @db.Decimal(10, 2)
  place             Int?
  marginBackSeconds Decimal? @db.Decimal(8, 2)
  rawSpeed          Decimal? @db.Decimal(6, 4) // m/s
  adjustedSpeed     Decimal? @db.Decimal(6, 4) // Normalized

  race   Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  lineup Lineup? @relation(fields: [lineupId], references: [id])

  @@map("race_results")
}

model ExternalTeam {
  id         String   @id @default(uuid())
  name       String   @unique
  conference String?
  division   String? // D1, D2, D3, Club
  createdAt  DateTime @default(now())

  externalRankings ExternalRanking[]

  @@map("external_teams")
}

// ============================================
// CHECKLISTS: Pre-race checklists
// ============================================

model ChecklistTemplate {
  id        String   @id @default(uuid())
  teamId    String
  name      String // "Home Regatta", "Away Regatta"
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  team       Team                    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  items      ChecklistTemplateItem[]
  checklists RaceChecklist[]

  @@index([teamId])
  @@map("checklist_templates")
}

model ChecklistTemplateItem {
  id         String @id @default(uuid())
  templateId String
  text       String
  role       String // "coach", "coxswain", "anyone"
  sortOrder  Int    @default(0)

  template ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("checklist_template_items")
}

model RaceChecklist {
  id         String   @id @default(uuid())
  raceId     String   @unique
  templateId String?
  createdAt  DateTime @default(now())

  race     Race                @relation(fields: [raceId], references: [id], onDelete: Cascade)
  template ChecklistTemplate?  @relation(fields: [templateId], references: [id])
  items    RaceChecklistItem[]

  @@map("race_checklists")
}

model RaceChecklistItem {
  id          String    @id @default(uuid())
  checklistId String
  text        String
  role        String
  completed   Boolean   @default(false)
  completedBy String? // User ID who completed
  completedAt DateTime?
  sortOrder   Int       @default(0)

  checklist RaceChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@map("race_checklist_items")
}

// ============================================
// EXTERNAL RANKINGS: Team rankings from external sources
// ============================================

model ExternalRanking {
  id             String   @id @default(uuid())
  teamId         String
  externalTeamId String
  boatClass      String
  source         String // "row2k", "usrowing", "regattacentral", "manual"
  ranking        Int
  season         String?
  updatedDate    DateTime
  notes          String?
  createdAt      DateTime @default(now())

  team         Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  externalTeam ExternalTeam @relation(fields: [externalTeamId], references: [id])

  @@unique([teamId, externalTeamId, boatClass, source, season])
  @@map("external_rankings")
}

model TeamSpeedEstimate {
  id               String   @id @default(uuid())
  teamId           String
  boatClass        String
  season           String? // "Spring 2025"
  rawSpeed         Decimal? @db.Decimal(6, 4)
  adjustedSpeed    Decimal? @db.Decimal(6, 4)
  confidenceScore  Decimal? @db.Decimal(4, 3)
  sampleCount      Int      @default(0)
  lastCalculatedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, boatClass, season])
  @@map("team_speed_estimates")
}

// ============================================
// BILLING: Subscriptions
// ============================================

model Subscription {
  id                   String    @id @default(uuid())
  teamId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  plan                 String    @default("free") // free, starter, pro, enterprise
  status               String    @default("active") // active, past_due, canceled, trialing
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  athleteLimit         Int       @default(15)
  coachLimit           Int       @default(1)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  team   Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  events SubscriptionEvent[]

  @@map("subscriptions")
}

model SubscriptionEvent {
  id             String   @id @default(uuid())
  subscriptionId String
  eventType      String // created, updated, canceled, payment_failed, payment_succeeded
  stripeEventId  String?  @unique
  data           Json?
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("subscription_events")
}

// ============================================
// CALENDAR: Team events and workouts
// ============================================

model CalendarEvent {
  id          String   @id @default(uuid())
  teamId      String
  title       String
  description String?
  eventType   String // erg-test, erg-pieces, steady-state, water, lift, rest, meeting, regatta
  date        DateTime
  startTime   String? // HH:MM format
  endTime     String? // HH:MM format
  location    String?
  completed   Boolean  @default(false)
  notes       String?
  visibility  String   @default("all") // all, coaches - controls who can see this event
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  waterSessions WaterSession[]

  @@index([teamId])
  @@index([date])
  @@map("calendar_events")
}

// ============================================
// ON-WATER SESSIONS: Coxswain recorded data
// ============================================

model WaterSession {
  id              String    @id @default(uuid())
  teamId          String
  date            DateTime  @default(now())
  startTime       DateTime?
  endTime         DateTime?
  location        String?
  conditions      String? // weather, water conditions
  notes           String?
  calendarEventId String?

  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  calendarEvent CalendarEvent? @relation(fields: [calendarEventId], references: [id])
  boatSessions  BoatSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([date])
  @@map("water_sessions")
}

model BoatSession {
  id             String  @id @default(uuid())
  waterSessionId String
  boatId         String? // Optional link to BoatConfig/Lineup
  boatName       String
  coxswainId     String?
  notes          String?

  waterSession WaterSession @relation(fields: [waterSessionId], references: [id], onDelete: Cascade)
  coxswain     User?        @relation(fields: [coxswainId], references: [id])
  pieces       WaterPiece[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([waterSessionId])
  @@index([coxswainId])
  @@map("boat_sessions")
}

model WaterPiece {
  id            String    @id @default(uuid())
  boatSessionId String
  pieceNumber   Int
  distance      Int? // meters
  timeSeconds   Decimal?  @db.Decimal(10, 1)
  strokeRate    Int?
  pieceType     String? // steady, interval, start, race
  notes         String?
  startTime     DateTime?

  boatSession BoatSession @relation(fields: [boatSessionId], references: [id], onDelete: Cascade)

  @@index([boatSessionId])
  @@map("water_pieces")
}

// ============================================
// SETTINGS: User preferences
// ============================================

model UserSettings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  darkMode           Boolean  @default(true)
  compactView        Boolean  @default(false)
  autoSave           Boolean  @default(true)
  firstName          String?
  lastName           String?
  role               String?
  avatar             String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// TRAINING PLANS: Periodized programs
// ============================================

model TrainingPlan {
  id          String    @id @default(uuid())
  name        String
  description String?
  teamId      String
  createdBy   String
  startDate   DateTime?
  endDate     DateTime?
  phase       String? // Base, Build, Peak, Taper
  isTemplate  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator     User                @relation("PlanCreator", fields: [createdBy], references: [id])
  workouts    PlannedWorkout[]
  assignments WorkoutAssignment[]

  @@index([teamId])
  @@index([createdBy])
  @@map("training_plans")
}

model PlannedWorkout {
  id              String    @id @default(uuid())
  planId          String
  name            String
  type            String // erg, row, cross_train
  description     String?
  scheduledDate   DateTime?
  dayOfWeek       Int? // 0-6 for recurring
  weekNumber      Int? // For periodization
  duration        Int? // seconds
  distance        Int? // meters
  targetPace      Float? // seconds per 500m
  targetHeartRate Int?
  intensity       String? // easy, moderate, hard, max
  recurrenceRule  Json? // For recurring workouts
  order           Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  plan        TrainingPlan        @relation(fields: [planId], references: [id], onDelete: Cascade)
  completions WorkoutCompletion[]

  @@index([planId])
  @@index([scheduledDate])
  @@map("planned_workouts")
}

model WorkoutAssignment {
  id         String    @id @default(uuid())
  planId     String
  athleteId  String
  assignedBy String
  assignedAt DateTime  @default(now())
  startDate  DateTime
  endDate    DateTime?
  status     String    @default("active") // active, completed, cancelled

  plan     TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  athlete  TeamMember   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  assigner User         @relation("PlanAssigner", fields: [assignedBy], references: [id])

  @@unique([planId, athleteId])
  @@index([athleteId])
  @@map("workout_assignments")
}

model WorkoutCompletion {
  id               String   @id @default(uuid())
  plannedWorkoutId String
  athleteId        String
  workoutId        String? // Link to actual Workout record
  completedAt      DateTime @default(now())
  compliance       Float? // 0-1, how well targets were met
  notes            String?

  plannedWorkout PlannedWorkout @relation(fields: [plannedWorkoutId], references: [id], onDelete: Cascade)
  athlete        TeamMember     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  workout        Workout?       @relation(fields: [workoutId], references: [id])

  @@unique([plannedWorkoutId, athleteId])
  @@index([athleteId])
  @@map("workout_completions")
}

// ============================================
// SESSIONS: Unified training session model
// ============================================

enum SessionType {
  ERG
  ROW
  LIFT
  RUN
  CROSS_TRAIN
  RECOVERY
}

enum SessionStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PieceSegment {
  WARMUP
  MAIN
  COOLDOWN
}

model Session {
  id                String        @id @default(cuid())
  name              String
  type              SessionType
  date              DateTime
  startTime         DateTime?
  endTime           DateTime?
  recurrenceRule    String? // RRULE format for recurring sessions
  notes             String?       @db.Text
  status            SessionStatus @default(PLANNED)
  teamId            String
  createdById       String
  sessionCode       String?       @unique // For live session joining
  athleteVisibility Boolean       @default(true) // Can athletes see each other's data
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  team                Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy           User                 @relation("SessionCreator", fields: [createdById], references: [id])
  pieces              Piece[]
  attendance          SessionAttendance[]
  passiveObservations PassiveObservation[]

  @@index([teamId, date])
  @@map("sessions")
}

model Piece {
  id           String       @id @default(cuid())
  sessionId    String
  segment      PieceSegment @default(MAIN)
  name         String // e.g., "4x2000m", "40' SS"
  description  String?
  order        Int
  distance     Int? // meters
  duration     Int? // seconds
  targetSplit  Int? // seconds per 500m (in tenths)
  targetRate   Int? // strokes per minute
  targetWatts  Int?
  targetHRZone String?
  targetRPE    Int?
  notes        String?
  boatClass    String? // For ROW sessions
  sets         Int? // For LIFT sessions
  reps         Int? // For LIFT sessions

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, order])
  @@map("pieces")
}

// ============================================
// SESSION ATTENDANCE: Auto-recorded attendance
// ============================================

// Session attendance tracking
model SessionAttendance {
  id                   String    @id @default(cuid())
  sessionId            String
  athleteId            String
  status               String // Present, Late, Partial, Absent, Injured, Class
  participationPercent Float     @default(0) // 0-100
  autoRecorded         Boolean   @default(true)
  overriddenAt         DateTime?
  overriddenById       String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  session      Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  athlete      Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  overriddenBy User?    @relation("AttendanceOverrides", fields: [overriddenById], references: [id])

  @@unique([sessionId, athleteId])
  @@index([sessionId])
  @@index([athleteId])
  @@map("session_attendance")
}

// ============================================
// RECRUITING: Recruit Visit Management
// ============================================

model RecruitVisit {
  id              String    @id @default(cuid())
  teamId          String
  team            Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Recruit info
  recruitName     String
  recruitEmail    String?
  recruitPhone    String?
  recruitSchool   String?   // Current school
  recruitGradYear Int?      // Graduation year

  // Visit scheduling
  date            DateTime
  startTime       String    // HH:mm format
  endTime         String    // HH:mm format

  // Host assignment
  hostAthleteId   String?
  hostAthlete     Athlete?  @relation(fields: [hostAthleteId], references: [id], onDelete: SetNull)

  // Schedule content (PDF or rich text)
  scheduleType    String    @default("richtext") // "pdf" or "richtext"
  scheduleContent String?   @db.Text             // Rich text HTML (sanitized)
  schedulePdfUrl  String?                        // URL to uploaded PDF

  // Additional info
  notes           String?   @db.Text
  status          String    @default("scheduled") // scheduled, completed, cancelled

  // Sharing
  shareToken      String?   @unique              // For public share link
  shareEnabled    Boolean   @default(false)

  // Timestamps
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([teamId])
  @@index([hostAthleteId])
  @@index([date])
  @@index([shareToken])
  @@map("recruit_visits")
}

// ============================================
// GAMIFICATION: Achievements and Progress
// ============================================

model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  category    String   // "Erg", "Attendance", "Racing"
  type        String   // "first-time", "volume", "performance", "consistency"
  rarity      String   // "Common", "Rare", "Epic", "Legendary"
  criteria    Json     // { "type": "volume", "target": 500000, "metric": "meters" }
  icon        String?  // Icon name or URL
  createdAt   DateTime @default(now())

  athletes    AthleteAchievement[]

  @@unique([name, category])
  @@map("achievements")
}

model AthleteAchievement {
  athleteId     String
  achievementId String

  progress      Int       @default(0)    // Current progress (e.g., 23 out of 50)
  unlockedAt    DateTime?               // NULL = not yet unlocked
  isPinned      Boolean   @default(false) // Athlete's pinned badges (max 3-5)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  athlete     Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@id([athleteId, achievementId])
  @@index([athleteId])
  @@index([unlockedAt])
  @@map("athlete_achievements")
}

// ============================================
// GAMIFICATION: Team Challenges
// ============================================

model Challenge {
  id            String    @id @default(cuid())
  teamId        String
  name          String
  description   String?
  type          String    // "individual" or "collective"
  status        String    @default("active") // "active", "completed", "cancelled"

  // Timing
  startDate     DateTime
  endDate       DateTime

  // Scoring
  metric        String    // "meters", "workouts", "attendance", "composite"
  formula       Json?     // Custom formula config: { type: "weighted", weights: {...} }
  handicap      Json?     // Optional handicapping: { enabled: true, type: "weight-class", adjustments: {...} }

  // Template info
  templateId    String?   // NULL = custom challenge

  createdById   String    // User who created
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  participants  ChallengeParticipant[]

  @@index([teamId])
  @@index([status])
  @@index([endDate])
  @@map("challenges")
}

model ChallengeParticipant {
  id            String   @id @default(cuid())
  challengeId   String
  athleteId     String

  score         Decimal  @default(0) @db.Decimal(12, 2)
  rank          Int?     // Calculated on update
  contribution  Json?    // For collective: breakdown of individual contribution

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  athlete       Athlete   @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([challengeId, athleteId])
  @@index([challengeId])
  @@index([score])
  @@map("challenge_participants")
}

// ============================================
// GAMIFICATION: Personal Records
// ============================================

model PersonalRecord {
  id            String   @id @default(cuid())
  athleteId     String
  teamId        String

  // What type of PR
  testType      String   // "2k", "6k", "500m", etc.
  scope         String   // "all-time", "season", "training-block"
  scopeContext  String?  // Season name or training block ID

  // The record
  ergTestId     String   // Reference to the test that set this PR
  result        Decimal  @db.Decimal(10, 1) // Time in seconds
  previousBest  Decimal? @db.Decimal(10, 1) // Previous best for delta calculation
  improvement   Decimal? @db.Decimal(10, 1) // Delta in seconds (positive = improvement)

  achievedAt    DateTime @default(now())

  athlete       Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, testType, scope, scopeContext], name: "athlete_pr_unique")
  @@index([athleteId])
  @@index([teamId])
  @@index([testType])
  @@map("personal_records")
}

// ============================================
// BOAT CONFIGURATION: Rigging and Templates
// ============================================

model RiggingProfile {
  id        String   @id @default(cuid())
  shellId   String   @unique
  teamId    String
  defaults  Json     // { spread, span, catchAngle, finishAngle, oarLength, inboard, pitch, gateHeight }
  perSeat   Json?    // Optional per-seat overrides: { "1": { spread: 86 }, ... }
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shell Shell @relation(fields: [shellId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("rigging_profiles")
}

model LineupTemplate {
  id          String   @id @default(cuid())
  teamId      String
  name        String
  description String?
  boatClass   String
  assignments Json     // Array of { seatNumber, side, preferredAthleteId? }
  rigging     Json?    // Optional rigging snapshot
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@index([teamId])
  @@map("lineup_templates")
}

model EquipmentAssignment {
  id           String   @id @default(cuid())
  teamId       String
  lineupId     String?
  sessionId    String?  // Link to Session if used in practice
  shellId      String?
  oarSetId     String?
  assignedDate DateTime @db.Date
  notes        String?
  createdAt    DateTime @default(now())

  team   Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lineup Lineup?  @relation(fields: [lineupId], references: [id], onDelete: SetNull)
  shell  Shell?   @relation(fields: [shellId], references: [id], onDelete: SetNull)
  oarSet OarSet?  @relation(fields: [oarSetId], references: [id], onDelete: SetNull)

  @@index([teamId, assignedDate])
  @@index([shellId, assignedDate])
  @@map("equipment_assignments")
}
