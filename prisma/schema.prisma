// Prisma schema for RowLab v2.0
// PostgreSQL with multi-tenant team isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE: Users, Teams, Membership
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String?  @unique // Optional for admin accounts
  username      String?  @unique // For admin accounts (non-email login)
  passwordHash  String
  name          String
  isAdmin       Boolean  @default(false) // Admin accounts have special privileges
  status        String   @default("active") // active, suspended
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  memberships   TeamMember[]
  refreshTokens RefreshToken[]
  announcements Announcement[]
  settings      UserSettings?
  concept2Auth  Concept2Auth?
  stravaAuth    StravaAuth?
  boatSessions  BoatSession[]

  @@map("users")
}

model Team {
  id                String   @id @default(uuid())
  name              String
  slug              String   @unique
  inviteCode        String?  @unique
  isPublic          Boolean  @default(false)
  visibilitySetting String   @default("coaches_only") // open, coaches_only, opt_in
  settings          Json     @default("{}")
  aiModel           String?  // Preferred AI model (e.g., "phi4-mini-reasoning:3.8b")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members            TeamMember[]
  athletes           Athlete[]
  invitations        Invitation[]
  lineups            Lineup[]
  ergTests           ErgTest[]
  workouts           Workout[]
  announcements      Announcement[]
  shells             Shell[]
  boatConfigs        BoatConfig[]
  seatRaceSessions   SeatRaceSession[]
  regattas           Regatta[]
  teamSpeedEstimates TeamSpeedEstimate[]
  subscription       Subscription?
  calendarEvents     CalendarEvent[]
  waterSessions      WaterSession[]

  @@map("teams")
}

model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  role      String   // OWNER, COACH, ATHLETE
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

// ============================================
// AUTH: Tokens, Invitations
// ============================================

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String
  tokenHash   String   @unique
  familyId    String   // For rotation detection
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@map("refresh_tokens")
}

model Invitation {
  id        String   @id @default(uuid())
  teamId    String
  athleteId String?  // For claim flow
  email     String
  tokenHash String   @unique // SHA-256 of actual token
  expiresAt DateTime
  status    String   @default("pending") // pending, claimed, expired, revoked
  createdAt DateTime @default(now())

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athlete Athlete? @relation(fields: [athleteId], references: [id])

  @@index([tokenHash])
  @@map("invitations")
}

// ============================================
// ATHLETES: Profiles (managed or linked)
// ============================================

model Athlete {
  id              String   @id @default(uuid())
  teamId          String
  userId          String?  // NULL = managed by coach
  firstName       String
  lastName        String
  email           String?  // For invites
  side            String?  // Port, Starboard, Both, Cox
  isManaged       Boolean  @default(true)
  concept2UserId  String?
  weightKg        Decimal? @db.Decimal(5, 2)
  heightCm        Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  team                Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ergTests            ErgTest[]
  workouts            Workout[]
  assignments         LineupAssignment[]
  invitations         Invitation[]
  athleteRatings      AthleteRating[]
  telemetryData       AthleteTelemetry[]
  seatRaceAssignments SeatRaceAssignment[]

  @@unique([teamId, lastName, firstName])
  @@index([teamId])
  @@map("athletes")
}

model Concept2Auth {
  userId         String   @id
  c2UserId       String
  username       String?  // Concept2 username
  accessToken    String   @db.Text // OAuth access token (encrypted)
  refreshToken   String   @db.Text // OAuth refresh token (encrypted)
  tokenExpiresAt DateTime
  lastSyncedAt   DateTime?
  syncEnabled    Boolean  @default(true) // Auto-sync on webhook
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([c2UserId])
  @@map("concept2_auth")
}

model StravaAuth {
  userId         String   @id
  stravaAthleteId BigInt   // Strava athlete ID
  username       String?  // Strava username/display name
  accessToken    String   @db.Text // OAuth access token (encrypted)
  refreshToken   String   @db.Text // OAuth refresh token (encrypted)
  tokenExpiresAt DateTime
  lastSyncedAt   DateTime?
  syncEnabled    Boolean  @default(true) // Auto-sync from Strava to RowLab
  scope          String?  // OAuth scopes granted
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // C2 to Strava sync settings
  c2ToStravaEnabled  Boolean @default(false)  // Master toggle for C2→Strava uploads
  c2ToStravaTypes    Json    @default("{}") // Activity types to sync: {"rower": true, "bikeerg": false, ...}
  lastC2SyncedAt     DateTime? // Last C2→Strava sync timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stravaAthleteId])
  @@map("strava_auth")
}

// ============================================
// ERG DATA: Tests and Workouts
// ============================================

model ErgTest {
  id           String   @id @default(uuid())
  athleteId    String
  teamId       String
  testType     String   // 2k, 6k, 30min, 500m
  testDate     DateTime
  distanceM    Int?
  timeSeconds  Decimal  @db.Decimal(10, 1)
  splitSeconds Decimal? @db.Decimal(6, 1)
  watts        Int?
  strokeRate   Int?
  weightKg     Decimal? @db.Decimal(5, 2) // Weight at time of test
  notes        String?
  createdAt    DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([athleteId])
  @@map("erg_tests")
}

model Workout {
  id               String   @id @default(uuid())
  athleteId        String?  // Optional - may be synced by user without athlete record
  userId           String?  // For user-level syncs (Strava, etc.)
  teamId           String
  source           String   // manual, concept2_sync, strava_sync, csv_import, bluetooth, fit_import
  type             String?  // on_water, erg, strength, cardio, other
  c2LogbookId      String?  @unique
  stravaActivityId String?  @unique
  date             DateTime
  distanceM        Int?
  durationSeconds  Decimal? @db.Decimal(10, 1)
  strokeRate       Int?
  calories         Int?
  dragFactor       Int?
  deviceInfo       Json?
  rawData          Json?
  createdAt        DateTime @default(now())

  athlete   Athlete?          @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  team      Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  telemetry WorkoutTelemetry?

  @@index([teamId])
  @@index([athleteId])
  @@index([userId])
  @@map("workouts")
}

model WorkoutTelemetry {
  workoutId        String    @id
  timeSeriesS      Decimal[] @db.Decimal(10, 1)
  wattsSeries      Int[]
  heartRateSeries  Int[]
  strokeRateSeries Int[]
  forceCurves      Json?

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@map("workout_telemetry")
}

// ============================================
// LINEUPS: Boat assignments
// ============================================

model Lineup {
  id        String   @id @default(uuid())
  teamId    String
  name      String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team        Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignments LineupAssignment[]
  raceResults RaceResult[]

  @@index([teamId])
  @@map("lineups")
}

model LineupAssignment {
  id         String  @id @default(uuid())
  lineupId   String
  athleteId  String
  boatClass  String
  shellName  String?
  seatNumber Int
  side       String  // Port, Starboard
  isCoxswain Boolean @default(false)

  lineup  Lineup  @relation(fields: [lineupId], references: [id], onDelete: Cascade)
  athlete Athlete @relation(fields: [athleteId], references: [id])

  @@map("lineup_assignments")
}

model Shell {
  id        String  @id @default(uuid())
  teamId    String
  name      String
  boatClass String
  notes     String?

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("shells")
}

model BoatConfig {
  id          String  @id @default(uuid())
  teamId      String
  name        String  // e.g., "Varsity 8+"
  numSeats    Int
  hasCoxswain Boolean

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("boat_configs")
}

// ============================================
// COMMUNICATION: Announcements
// ============================================

model Announcement {
  id        String   @id @default(uuid())
  teamId    String
  authorId  String
  title     String
  content   String
  priority  String   @default("normal") // normal, important, urgent
  visibleTo String   @default("all")    // all, athletes, coaches
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team   Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User               @relation(fields: [authorId], references: [id])
  reads  AnnouncementRead[]

  @@index([teamId])
  @@map("announcements")
}

model AnnouncementRead {
  announcementId String
  userId         String
  readAt         DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@id([announcementId, userId])
  @@map("announcement_reads")
}

// ============================================
// SEAT RACING: Selection system
// ============================================

model SeatRaceSession {
  id          String   @id @default(uuid())
  teamId      String
  date        DateTime
  location    String?
  conditions  String?  // calm, variable, rough
  boatClass   String   // 8+, 4+, 4-, 2-
  description String?
  createdAt   DateTime @default(now())

  team   Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  pieces SeatRacePiece[]

  @@index([teamId])
  @@map("seat_race_sessions")
}

model SeatRacePiece {
  id            String  @id @default(uuid())
  sessionId     String
  sequenceOrder Int
  distanceMeters Int?
  direction     String? // upstream, downstream
  notes         String?

  session SeatRaceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  boats   SeatRaceBoat[]

  @@map("seat_race_pieces")
}

model SeatRaceBoat {
  id                String   @id @default(uuid())
  pieceId           String
  name              String   // "Boat A", "Boat B"
  shellName         String?
  finishTimeSeconds Decimal? @db.Decimal(10, 2)
  handicapSeconds   Decimal  @default(0) @db.Decimal(5, 2)

  piece       SeatRacePiece        @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  assignments SeatRaceAssignment[]

  @@map("seat_race_boats")
}

model SeatRaceAssignment {
  id         String @id @default(uuid())
  boatId     String
  athleteId  String
  seatNumber Int    // 1=Bow, 8=Stroke, 9=Cox
  side       String // Port, Starboard, Cox

  boat    SeatRaceBoat @relation(fields: [boatId], references: [id], onDelete: Cascade)
  athlete Athlete      @relation(fields: [athleteId], references: [id])

  @@map("seat_race_assignments")
}

model AthleteRating {
  id              String   @id @default(uuid())
  athleteId       String
  teamId          String
  ratingType      String   // seat_race_elo, combined
  ratingValue     Decimal  @default(1000) @db.Decimal(8, 2)
  confidenceScore Decimal? @db.Decimal(4, 3)
  racesCount      Int      @default(0)
  lastCalculatedAt DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([athleteId, ratingType])
  @@map("athlete_ratings")
}

// ============================================
// TELEMETRY: Oarlock/sensor data
// ============================================

model AthleteTelemetry {
  id             String   @id @default(uuid())
  athleteId      String
  sessionDate    DateTime
  source         String   // empower, peach, nk
  seatNumber     Int?
  avgWatts       Decimal? @db.Decimal(6, 2)
  peakWatts      Decimal? @db.Decimal(6, 2)
  workPerStroke  Decimal? @db.Decimal(8, 2)
  slipDegrees    Decimal? @db.Decimal(5, 2)
  washDegrees    Decimal? @db.Decimal(5, 2)
  catchAngle     Decimal? @db.Decimal(5, 2)
  finishAngle    Decimal? @db.Decimal(5, 2)
  peakForceAngle Decimal? @db.Decimal(5, 2)
  techScore      Decimal? @db.Decimal(5, 2)
  createdAt      DateTime @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
  @@map("athlete_telemetry")
}

// ============================================
// RACING: Regattas, Races, Results
// ============================================

model Regatta {
  id          String   @id @default(uuid())
  teamId      String
  name        String
  location    String?
  date        DateTime
  courseType  String?  // 2000m, 1500m, head
  conditions  Json?    // wind, temp, current
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  races Race[]

  @@index([teamId])
  @@map("regattas")
}

model Race {
  id             String    @id @default(uuid())
  regattaId      String
  eventName      String
  boatClass      String
  distanceMeters Int       @default(2000)
  isHeadRace     Boolean   @default(false)
  scheduledTime  DateTime?

  regatta Regatta      @relation(fields: [regattaId], references: [id], onDelete: Cascade)
  results RaceResult[]

  @@map("races")
}

model RaceResult {
  id                String   @id @default(uuid())
  raceId            String
  teamName          String
  isOwnTeam         Boolean  @default(false)
  lineupId          String?
  finishTimeSeconds Decimal? @db.Decimal(10, 2)
  place             Int?
  marginBackSeconds Decimal? @db.Decimal(8, 2)
  rawSpeed          Decimal? @db.Decimal(6, 4)    // m/s
  adjustedSpeed     Decimal? @db.Decimal(6, 4)    // Normalized

  race   Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  lineup Lineup? @relation(fields: [lineupId], references: [id])

  @@map("race_results")
}

model ExternalTeam {
  id         String   @id @default(uuid())
  name       String   @unique
  conference String?
  division   String?  // D1, D2, D3, Club
  createdAt  DateTime @default(now())

  @@map("external_teams")
}

model TeamSpeedEstimate {
  id               String   @id @default(uuid())
  teamId           String
  boatClass        String
  season           String?  // "Spring 2025"
  rawSpeed         Decimal? @db.Decimal(6, 4)
  adjustedSpeed    Decimal? @db.Decimal(6, 4)
  confidenceScore  Decimal? @db.Decimal(4, 3)
  sampleCount      Int      @default(0)
  lastCalculatedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, boatClass, season])
  @@map("team_speed_estimates")
}

// ============================================
// BILLING: Subscriptions
// ============================================

model Subscription {
  id                   String    @id @default(uuid())
  teamId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  plan                 String    @default("free") // free, starter, pro, enterprise
  status               String    @default("active") // active, past_due, canceled, trialing
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  athleteLimit         Int       @default(15)
  coachLimit           Int       @default(1)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  team   Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  events SubscriptionEvent[]

  @@map("subscriptions")
}

model SubscriptionEvent {
  id             String   @id @default(uuid())
  subscriptionId String
  eventType      String // created, updated, canceled, payment_failed, payment_succeeded
  stripeEventId  String?  @unique
  data           Json?
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("subscription_events")
}

// ============================================
// CALENDAR: Team events and workouts
// ============================================

model CalendarEvent {
  id          String   @id @default(uuid())
  teamId      String
  title       String
  description String?
  eventType   String   // erg-test, erg-pieces, steady-state, water, lift, rest, meeting, regatta
  date        DateTime
  startTime   String?  // HH:MM format
  endTime     String?  // HH:MM format
  location    String?
  completed   Boolean  @default(false)
  notes       String?
  visibility  String   @default("all") // all, coaches - controls who can see this event
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  waterSessions WaterSession[]

  @@index([teamId])
  @@index([date])
  @@map("calendar_events")
}

// ============================================
// ON-WATER SESSIONS: Coxswain recorded data
// ============================================

model WaterSession {
  id              String    @id @default(uuid())
  teamId          String
  date            DateTime  @default(now())
  startTime       DateTime?
  endTime         DateTime?
  location        String?
  conditions      String?   // weather, water conditions
  notes           String?
  calendarEventId String?

  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  calendarEvent CalendarEvent? @relation(fields: [calendarEventId], references: [id])
  boatSessions  BoatSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([date])
  @@map("water_sessions")
}

model BoatSession {
  id             String  @id @default(uuid())
  waterSessionId String
  boatId         String? // Optional link to BoatConfig/Lineup
  boatName       String
  coxswainId     String?
  notes          String?

  waterSession WaterSession @relation(fields: [waterSessionId], references: [id], onDelete: Cascade)
  coxswain     User?        @relation(fields: [coxswainId], references: [id])
  pieces       WaterPiece[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([waterSessionId])
  @@index([coxswainId])
  @@map("boat_sessions")
}

model WaterPiece {
  id            String   @id @default(uuid())
  boatSessionId String
  pieceNumber   Int
  distance      Int?     // meters
  timeSeconds   Decimal? @db.Decimal(10, 1)
  strokeRate    Int?
  pieceType     String?  // steady, interval, start, race
  notes         String?
  startTime     DateTime?

  boatSession BoatSession @relation(fields: [boatSessionId], references: [id], onDelete: Cascade)

  @@index([boatSessionId])
  @@map("water_pieces")
}

// ============================================
// SETTINGS: User preferences
// ============================================

model UserSettings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(false)
  darkMode           Boolean  @default(true)
  compactView        Boolean  @default(false)
  autoSave           Boolean  @default(true)
  firstName          String?
  lastName           String?
  role               String?
  avatar             String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}
